import gi
gi.require_version("Gtk", "4.0")
from gi.repository import Gtk, Gdk, Gio, cairo


class Overlay(Gtk.DrawingArea):
    def __init__(self, boxes, img_w, img_h):
        super().__init__()
        self.boxes = boxes
        self.img_w = img_w
        self.img_h = img_h
        self.set_draw_func(self.on_draw)

    def on_draw(self, area, ctx, width, height):
        scale = min(width / self.img_w, height / self.img_h)

        render_w = self.img_w * scale
        render_h = self.img_h * scale

        offset_x = (width - render_w) / 2
        offset_y = (height - render_h) / 2

        ctx.set_source_rgba(0.2, 0.5, 1.0, 0.3)

        for b in self.boxes:
            x = offset_x + b["x"] * scale
            y = offset_y + b["y"] * scale
            w = b["w"] * scale
            h = b["h"] * scale

            ctx.rectangle(x, y, w, h)

        ctx.fill()


class Viewer(Gtk.Application):
    def __init__(self, image_path, boxes):
        super().__init__(application_id="ocr.viewer")
        self.image_path = image_path
        self.boxes = boxes

    def do_activate(self):
        win = Gtk.ApplicationWindow(application=self)
        win.set_title("OCR Viewer")
        win.set_default_size(900, 600)

        file = Gio.File.new_for_path(self.image_path)
        texture = Gdk.Texture.new_from_file(file)

        img_w = texture.get_width()
        img_h = texture.get_height()

        image = Gtk.Picture.new_for_paintable(texture)
        image.set_content_fit(Gtk.ContentFit.CONTAIN)

        overlay = Gtk.Overlay()
        overlay.set_child(image)

        draw = Overlay(self.boxes, img_w, img_h)
        overlay.add_overlay(draw)

        win.set_child(overlay)
        win.present()
